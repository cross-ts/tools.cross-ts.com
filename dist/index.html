<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>モダンノートアプリ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* カスタムスクロールバー（任意） */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
    <header class="flex justify-between items-center mb-8 p-4 bg-white rounded-xl shadow-lg">
        <h1 class="text-4xl font-extrabold text-gray-800">モダンノート</h1>
        <button id="addNoteButton" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            新しいノート
        </button>
    </header>

    <div id="userIdDisplay" class="text-center text-gray-600 text-sm mb-6 hidden">
        ユーザーID: <span id="currentUserId" class="font-mono bg-gray-200 px-2 py-1 rounded-md text-xs"></span>
    </div>

    <div id="notesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <!-- ノートがここに動的に挿入されます -->
    </div>

    <div id="emptyState" class="text-center text-gray-500 text-lg mt-20 hidden">
        まだノートがありません。新しいノートを追加しましょう！
    </div>

    <!-- ノート追加/編集モーダル -->
    <div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div id="noteModalContent" class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-100 opacity-100">
            <h2 id="modalTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center"></h2>
            <form id="noteForm">
                <div class="mb-4">
                    <label for="noteTitle" class="block text-gray-700 text-sm font-semibold mb-2">タイトル</label>
                    <input
                        type="text"
                        id="noteTitle"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200"
                        placeholder="ノートのタイトル"
                    />
                </div>
                <div class="mb-6">
                    <label for="noteContent" class="block text-gray-700 text-sm font-semibold mb-2">内容</label>
                    <textarea
                        id="noteContent"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 h-32 resize-y"
                        placeholder="ノートの内容"
                    ></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button
                        type="button"
                        id="cancelNoteButton"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-5 rounded-lg transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-300"
                    >
                        キャンセル
                    </button>
                    <button
                        type="submit"
                        id="saveNoteButton"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-300"
                    >
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ローディング表示 -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-xl font-semibold text-gray-700">読み込み中...</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db;
        let auth;
        let currentUserId = null;
        let currentEditingNoteId = null; // 編集中のノートID

        const notesContainer = document.getElementById('notesContainer');
        const emptyState = document.getElementById('emptyState');
        const addNoteButton = document.getElementById('addNoteButton');
        const noteModal = document.getElementById('noteModal');
        const modalTitle = document.getElementById('modalTitle');
        const noteTitleInput = document.getElementById('noteTitle');
        const noteContentInput = document.getElementById('noteContent');
        const noteForm = document.getElementById('noteForm');
        const cancelNoteButton = document.getElementById('cancelNoteButton');
        const saveNoteButton = document.getElementById('saveNoteButton');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const currentUserIdSpan = document.getElementById('currentUserId');

        // Firebaseの初期化と認証
        async function initializeFirebase() {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        currentUserIdSpan.textContent = currentUserId;
                        userIdDisplay.classList.remove('hidden');
                        setupRealtimeNotesListener();
                    } else {
                        if (typeof __initial_auth_token !== 'undefined') {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (error) {
                                console.error("カスタムトークンでのサインインに失敗しました:", error);
                                await signInAnonymously(auth); // フォールバックとして匿名認証
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    loadingOverlay.classList.add('hidden'); // 認証状態が確定したらローディング終了
                });
            } catch (error) {
                console.error("Firebaseの初期化または認証中にエラーが発生しました:", error);
                loadingOverlay.classList.add('hidden');
            }
        }

        // ノートのリアルタイムリスナー設定
        function setupRealtimeNotesListener() {
            if (!db || !currentUserId) {
                console.error("FirestoreまたはユーザーIDが利用できません。");
                return;
            }

            const notesCollectionRef = collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${currentUserId}/notes`);
            const q = query(notesCollectionRef);

            onSnapshot(q, (snapshot) => {
                const fetchedNotes = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // 日付でソート（新しいものが上に来るように）
                fetchedNotes.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                renderNotes(fetchedNotes);
            }, (error) => {
                console.error("ノートの取得中にエラーが発生しました:", error);
            });
        }

        // ノートをDOMにレンダリングする関数
        function renderNotes(notes) {
            notesContainer.innerHTML = ''; // 既存のノートをクリア
            if (notes.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                notes.forEach(note => {
                    const noteItem = document.createElement('div');
                    noteItem.className = 'bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col justify-between';
                    noteItem.innerHTML = `
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2 break-words">${escapeHtml(note.title)}</h3>
                            <p class="text-gray-600 text-sm mb-4 whitespace-pre-wrap break-words">${escapeHtml(note.content)}</p>
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button class="edit-button p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-300 transition duration-200" title="編集" data-id="${note.id}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button class="delete-button p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-300 transition duration-200" title="削除" data-id="${note.id}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                    notesContainer.appendChild(noteItem);
                });

                // イベントリスナーを再割り当て
                document.querySelectorAll('.edit-button').forEach(button => {
                    button.onclick = (e) => {
                        const id = e.currentTarget.dataset.id;
                        const noteToEdit = notes.find(n => n.id === id);
                        openNoteModal(noteToEdit);
                    };
                });
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.onclick = (e) => {
                        const id = e.currentTarget.dataset.id;
                        handleDeleteNote(id);
                    };
                });
            }
        }

        // HTMLエスケープ関数
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // ノート追加/編集モーダルを開く
        function openNoteModal(note = null) {
            currentEditingNoteId = note ? note.id : null;
            modalTitle.textContent = note ? 'ノートを編集' : '新しいノートを作成';
            noteTitleInput.value = note ? note.title : '';
            noteContentInput.value = note ? note.content : '';
            noteModal.classList.remove('hidden');
        }

        // ノート追加/編集モーダルを閉じる
        function closeNoteModal() {
            noteModal.classList.add('hidden');
            currentEditingNoteId = null;
            noteTitleInput.value = '';
            noteContentInput.value = '';
        }

        // ノートの保存処理
        noteForm.onsubmit = async (e) => {
            e.preventDefault();
            const title = noteTitleInput.value.trim();
            const content = noteContentInput.value.trim();

            if (!title && !content) {
                console.log("タイトルと内容の両方が空です。");
                closeNoteModal();
                return;
            }

            if (!db || !currentUserId) {
                console.error("FirestoreまたはユーザーIDが利用できません。");
                return;
            }

            try {
                if (currentEditingNoteId) {
                    // 既存のノートを更新
                    const noteRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${currentUserId}/notes`, currentEditingNoteId);
                    await updateDoc(noteRef, {
                        title: title,
                        content: content,
                        updatedAt: new Date(),
                    });
                    console.log("ノートが更新されました:", currentEditingNoteId);
                } else {
                    // 新しいノートを追加
                    const notesCollectionRef = collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${currentUserId}/notes`);
                    await addDoc(notesCollectionRef, {
                        title: title,
                        content: content,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                    });
                    console.log("新しいノートが追加されました。");
                }
                closeNoteModal();
            } catch (e) {
                console.error("ノートの保存中にエラーが発生しました:", e);
            }
        };

        // ノートの削除処理
        async function handleDeleteNote(id) {
            if (!db || !currentUserId) {
                console.error("FirestoreまたはユーザーIDが利用できません。");
                return;
            }

            // カスタム確認モーダルを表示
            const confirmDelete = await new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                        <p class="text-lg font-semibold mb-4">このノートを削除しますか？</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirmBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">削除</button>
                            <button id="cancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">キャンセル</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirmBtn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };
                document.getElementById('cancelBtn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
            });

            if (confirmDelete) {
                try {
                    await deleteDoc(doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${currentUserId}/notes`, id));
                    console.log("ノートが削除されました:", id);
                } catch (e) {
                    console.error("ノートの削除中にエラーが発生しました:", e);
                }
            }
        }

        // イベントリスナーの設定
        addNoteButton.onclick = () => openNoteModal();
        cancelNoteButton.onclick = () => closeNoteModal();

        // モーダルの外側をクリックで閉じる
        noteModal.onclick = (e) => {
            if (e.target === noteModal) {
                closeNoteModal();
            }
        };

        // 初期化
        window.onload = initializeFirebase;
    </script>
</body>
</html>
